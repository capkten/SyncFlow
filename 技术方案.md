# 文件同步助手 - 技术方案

## 1. 技术选型

### 1.1 编程语言：Python
**选择理由**：
- ✅ 开发效率高，代码简洁
- ✅ 跨平台支持好
- ✅ 丰富的第三方库生态
- ✅ 适合快速迭代

### 1.2 核心技术栈

| 模块 | 技术选型 | 说明 |
|------|---------|------|
| **文件监控** | `watchdog` | 跨平台文件系统事件监控库 |
| **Web 框架** | `FastAPI` | 现代、高性能的 Web 框架 |
| **前端界面** | `Vue.js 3` + `Element Plus` | 响应式 Web 管理界面 |
| **网络传输** | `paramiko` (SFTP/SSH) | 安全的文件传输 |
| **数据库** | `SQLite` + `SQLAlchemy` | 轻量级数据库，存储配置和日志 |
| **配置管理** | `YAML` + `pydantic` | 配置文件格式 + 数据验证 |
| **日志系统** | `loguru` | 优雅的日志库 |

---

## 2. 核心功能实现

### 2.1 文件监控（watchdog）
```python
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

# 监控文件变化事件：
# - 文件创建 (on_created)
# - 文件修改 (on_modified)
# - 文件删除 (on_deleted)
# - 文件移动 (on_moved)
```

### 2.2 换行符统一处理 ⭐ **重点**
**问题描述**：
- Windows 使用 `CRLF` (\r\n) 作为换行符
- Linux 使用 `LF` (\n) 作为换行符
- Git 中经常因此产生误报修改

**解决方案**：
```python
def normalize_line_endings(file_path, target='LF'):
    """统一换行符
    
    Args:
        file_path: 文件路径
        target: 'LF' 或 'CRLF'
    """
    # 1. 检测文件是否为文本文件
    # 2. 读取内容并统一换行符
    # 3. 写回文件
    
# 配置选项：
# - auto：自动检测目标系统
# - lf：统一为 LF（推荐，Git 默认）
# - crlf：统一为 CRLF
# - keep：保持原样
```

**实现策略**：
1. **同步前检查**：计算文件哈希前，先统一换行符
2. **文本文件识别**：使用 MIME 类型或扩展名判断
3. **二进制文件跳过**：图片、视频等不处理
4. **.gitattributes 集成**（可选）：读取项目的 `.gitattributes` 配置

### 2.3 文件哈希校验
```python
import hashlib

def calculate_file_hash(file_path, normalize_eol=True):
    """计算文件 MD5 哈希值
    
    Args:
        file_path: 文件路径
        normalize_eol: 是否先统一换行符
    """
    # 1. 如果是文本文件且 normalize_eol=True，先统一换行符
    # 2. 计算 MD5 哈希
    # 3. 返回哈希值
```

### 2.4 单向同步流程
```
[源端监控] → [变化检测] → [换行符处理] → [传输到目标端] → [记录日志]
    ↓
[文件事件]
  ├─ 创建：完整复制
  ├─ 修改：覆盖目标文件
  ├─ 删除：删除目标文件
  └─ 移动：在目标端同步移动
```

---

## 3. 项目架构

### 3.1 目录结构
```
文件同步助手/
├── backend/                    # 后端服务
│   ├── app.py                 # FastAPI 主应用
│   ├── config/                # 配置模块
│   │   ├── settings.py       # 配置加载
│   │   └── config.yaml       # 配置文件示例
│   ├── core/                  # 核心功能
│   │   ├── file_watcher.py   # 文件监控
│   │   ├── sync_engine.py    # 同步引擎
│   │   ├── transfer.py       # 文件传输
│   │   └── eol_normalizer.py # 换行符处理
│   ├── models/                # 数据模型
│   │   ├── database.py       # 数据库连接
│   │   └── sync_task.py      # 同步任务模型
│   ├── api/                   # API 路由
│   │   ├── tasks.py          # 任务管理 API
│   │   ├── config.py         # 配置管理 API
│   │   └── logs.py           # 日志查询 API
│   └── utils/                 # 工具函数
│       ├── logger.py         # 日志工具
│       └── file_utils.py     # 文件工具
├── frontend/                  # 前端界面
│   ├── index.html            # 主页面
│   ├── static/
│   │   ├── css/
│   │   └── js/
│   │       └── app.js        # Vue.js 应用
│   └── components/           # Vue 组件（可选）
├── tests/                     # 测试代码
│   ├── test_watcher.py
│   ├── test_sync.py
│   └── test_eol.py
├── logs/                      # 日志目录
├── data/                      # 数据目录（SQLite）
├── requirements.txt           # Python 依赖
├── README.md                  # 使用说明
└── config.yaml                # 用户配置文件
```

### 3.2 数据库设计（SQLite）

#### 同步任务表 (sync_tasks)
```sql
CREATE TABLE sync_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,           -- 任务名称
    source_path TEXT NOT NULL,            -- 源目录路径
    target_host VARCHAR(100),             -- 目标主机地址
    target_path TEXT NOT NULL,            -- 目标目录路径
    target_type VARCHAR(20),              -- local/ssh/sftp
    enabled BOOLEAN DEFAULT 1,            -- 是否启用
    auto_start BOOLEAN DEFAULT 1,         -- 是否自动启动
    eol_normalize VARCHAR(10) DEFAULT 'lf', -- 换行符处理：lf/crlf/keep
    exclude_patterns TEXT,                -- 排除规则（JSON数组）
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 同步日志表 (sync_logs)
```sql
CREATE TABLE sync_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id INTEGER,                      -- 关联任务ID
    event_type VARCHAR(20),               -- created/modified/deleted/moved
    file_path TEXT,                       -- 文件路径
    status VARCHAR(20),                   -- success/failed/skipped
    error_message TEXT,                   -- 错误信息
    sync_time TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES sync_tasks(id)
);
```

---

## 4. 配置文件示例（config.yaml）

```yaml
# 全局配置
global:
  log_level: INFO               # 日志级别
  database_path: ./data/sync.db # 数据库路径
  
# 同步任务列表
sync_tasks:
  - name: "项目代码同步"
    source_path: "D:/projects/my-app"
    target:
      type: "ssh"               # local/ssh/sftp
      host: "192.168.1.100"
      port: 22
      username: "user"
      password: "password"      # 或使用 ssh_key_path
      path: "/home/user/my-app"
    enabled: true
    auto_start: true
    eol_normalize: "lf"         # lf/crlf/keep
    exclude_patterns:
      - "*.pyc"
      - "__pycache__"
      - ".git"
      - "node_modules"
      - ".idea"
      - "*.log"
    file_extensions:            # 仅同步这些类型（为空则全部）
      - ".py"
      - ".js"
      - ".md"
      - ".json"
      
  - name: "数据文件同步"
    source_path: "D:/data"
    target:
      type: "local"
      path: "E:/backup/data"
    enabled: true
    auto_start: false
    eol_normalize: "keep"       # 数据文件保持原样
    exclude_patterns:
      - "*.tmp"
      - "*.cache"
```

---

## 5. Web 管理界面功能

### 5.1 页面布局
```
┌────────────────────────────────────────┐
│  文件同步助手 - 管理界面               │
├────────────────────────────────────────┤
│ [仪表盘] [任务管理] [日志] [设置]      │
├────────────────────────────────────────┤
│                                        │
│  📊 仪表盘                              │
│  ┌──────────┐ ┌──────────┐            │
│  │ 运行中   │ │ 今日同步 │            │
│  │  2 个    │ │ 158 文件 │            │
│  └──────────┘ └──────────┘            │
│                                        │
│  📁 同步任务列表                        │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓    │
│  ┃ 项目代码同步   [运行中] [停止] ┃    │
│  ┃ D:/projects/my-app → 192.... ┃    │
│  ┃ 已同步: 158 文件 | 最后: 1分钟前┃    │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛    │
│                                        │
│  [+ 新建任务]                          │
└────────────────────────────────────────┘
```

### 5.2 核心功能
- ✅ 仪表盘：显示所有任务状态、实时统计
- ✅ 任务管理：创建/编辑/删除/启动/停止任务
- ✅ 实时日志：WebSocket 实时显示同步日志
- ✅ 配置管理：可视化编辑排除规则、换行符设置
- ✅ 手动同步：触发全量同步按钮

---

## 6. API 接口设计

### 6.1 任务管理
```
GET    /api/tasks              # 获取所有任务
POST   /api/tasks              # 创建新任务
GET    /api/tasks/{id}         # 获取任务详情
PUT    /api/tasks/{id}         # 更新任务
DELETE /api/tasks/{id}         # 删除任务
POST   /api/tasks/{id}/start   # 启动任务
POST   /api/tasks/{id}/stop    # 停止任务
POST   /api/tasks/{id}/sync    # 手动触发全量同步
```

### 6.2 日志查询
```
GET /api/logs?task_id={id}&limit=100  # 查询日志
GET /api/logs/stats                   # 统计信息
```

### 6.3 WebSocket 实时推送
```
WS /ws/logs          # 实时日志推送
WS /ws/task-status   # 任务状态推送
```

---

## 7. 实现优先级（MVP阶段）

### Phase 1：核心同步功能（1-2周）
- [x] 文件监控（watchdog）
- [x] 本地文件同步（source → target，都在本地）
- [x] 换行符统一处理 ⭐
- [x] 基本排除规则（.git, node_modules等）
- [x] 日志记录

### Phase 2：远程传输（1周）
- [x] SSH/SFTP 支持（paramiko）
- [x] 基本错误处理和重试

### Phase 3：Web 界面（1-2周）
- [x] FastAPI 后端 API
- [x] Vue.js 管理界面
- [x] 任务 CRUD
- [x] 实时日志展示

### Phase 4：多任务支持（1周）
- [x] 多个同步任务并行运行
- [x] 任务状态管理
- [x] 配置文件加载

---

## 8. 技术难点与解决方案

### 8.1 换行符处理
**难点**：如何高效检测文本文件并统一换行符？

**解决方案**：
1. **白名单机制**：预定义常见文本文件扩展名列表
2. **MIME 检测**：使用 `python-magic` 检测文件类型
3. **启发式检测**：读取前 8KB，检查是否包含 null 字节
4. **缓存机制**：记录已检测的文件类型，减少重复检测

```python
TEXT_EXTENSIONS = {
    '.py', '.js', '.java', '.c', '.cpp', '.h',
    '.md', '.txt', '.json', '.yaml', '.yml',
    '.xml', '.html', '.css', '.sql', '.sh'
}

def is_text_file(file_path):
    ext = os.path.splitext(file_path)[1].lower()
    if ext in TEXT_EXTENSIONS:
        return True
    # 启发式检测
    try:
        with open(file_path, 'rb') as f:
            chunk = f.read(8192)
            return b'\x00' not in chunk
    except:
        return False
```

### 8.2 大文件处理
**难点**：大文件同步可能占用大量内存

**解决方案**：
- 分块读写（chunk size = 8MB）
- 显示传输进度条
- 异步传输（不阻塞文件监控）

### 8.3 网络异常处理
**难点**：网络不稳定导致传输失败

**解决方案**：
- 自动重试机制（最多3次）
- 失败任务队列，定期重试
- 心跳检测，自动重连

---

## 9. 部署方案

### 9.1 开发环境
```bash
# 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Linux
venv\Scripts\activate     # Windows

# 安装依赖
pip install -r requirements.txt

# 启动服务
python backend/app.py
```

### 9.2 生产部署
**方案一：直接运行**
```bash
# 后台运行
nohup python backend/app.py > logs/app.log 2>&1 &
```

**方案二：系统服务（Linux）**
```ini
# /etc/systemd/system/file-sync.service
[Unit]
Description=文件同步助手
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/project
ExecStart=/path/to/venv/bin/python backend/app.py
Restart=always

[Install]
WantedBy=multi-user.target
```

**方案三（可选）：Docker**
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "backend/app.py"]
```

---

## 10. 测试策略

### 10.1 单元测试
- 换行符转换测试
- 文件哈希计算测试
- 排除规则匹配测试

### 10.2 集成测试
- 本地同步测试
- SSH 远程同步测试
- 多任务并发测试

### 10.3 边界测试
- 大文件（>1GB）
- 大量小文件（>10000个）
- 网络中断恢复

---

*文档版本：v1.0*  
*最后更新：2026-01-26*
