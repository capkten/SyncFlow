# 文件同步助手 - 代码审计报告 V3

**审计日期**：2026-01-27
**审计版本**：Codex 修改后
**对比基准**：代码审计报告_v2.md

---

## 一、修复情况总览

### ✅ 已修复问题

| 原问题 | 修复状态 | 修复方式 |
|--------|----------|----------|
| **密码明文存储** | ✅ 已修复 | 新增 `crypto.py`，使用 Fernet (AES) 加密 |
| **裸 except 捕获** | ✅ 已修复 | `transfer.py` 改为 `except Exception as e` 并记录日志 |
| **API 重复代码** | ✅ 已修复 | `tasks.py` 抽取 `_build_task_response()` 公共函数 |
| **sync_file 无返回值** | ✅ 部分修复 | 方法签名改为 `-> bool`，SSH 引擎失败时抛出异常 |

### ⚠️ 部分修复/仍需改进

| 问题 | 状态 | 说明 |
|------|------|------|
| **同步状态记录不准确** | ⚠️ 部分修复 | SSH 引擎会抛异常，但 TaskRunner 中仍有"假设成功"注释 |
| **LocalSyncEngine 错误处理** | ⚠️ 需注意 | 内部方法失败会抛出异常，但 `sync_file` 自身无 try-catch |

### ❌ 未修复问题

| 问题 | 优先级 | 说明 |
|------|--------|------|
| WebSocket 实时推送 | 中 | 仍使用 5 秒轮询 |
| 集成测试 | 中 | 测试文件无变化 |
| requirements.txt 缺依赖 | 高 | 缺少 `cryptography` 包 |

---

## 二、新增模块分析

### 2.1 密码加密模块 (`backend/utils/crypto.py`)

**实现质量**：⭐⭐⭐⭐ 良好

```python
# 核心功能
- encrypt_secret(value) -> 加密后带 "enc:" 前缀
- decrypt_secret(value) -> 自动识别并解密
- 密钥管理：优先环境变量 TONGBU_SECRET_KEY，否则自动生成到 data/secret.key
```

**优点**：
- ✅ 使用工业标准 Fernet (AES-128-CBC + HMAC)
- ✅ 幂等设计：已加密的值不会重复加密
- ✅ 支持环境变量配置，便于生产部署
- ✅ 密钥文件自动创建

**改进建议**：
- 密钥文件 `data/secret.key` 应添加到 `.gitignore`（检查是否已添加）
- 考虑添加密钥轮换机制

### 2.2 数据模型改动 (`backend/models/sync_task.py`)

```python
# 第 76-78 行：创建任务时自动加密
if 'target_password' in task_data:
    task_data['target_password'] = encrypt_secret(task_data.get('target_password'))

# 第 108-110 行：更新任务时自动加密
if 'target_password' in task_data:
    task_data['target_password'] = encrypt_secret(task_data.get('target_password'))
```

**优点**：
- ✅ 透明加密，调用方无需关心加密逻辑

### 2.3 任务管理器改动 (`backend/core/task_manager.py`)

```python
# 第 16 行：新增导入
from backend.utils.crypto import decrypt_secret

# 第 44, 297, 309, 382, 394 行：读取密码时解密
'password': decrypt_secret(task.target_password),
```

**优点**：
- ✅ 所有读取密码的地方都调用了 `decrypt_secret`

---

## 三、代码质量详细分析

### 3.1 同步引擎改进 (`backend/core/sync_engine.py`)

**改动点**：
- 第 103 行：`sync_file` 返回类型改为 `-> bool`
- 第 149, 330 行：实现类返回 `True`
- 第 362-368 行：`SshSyncEngine.sync_file` 失败时重新抛出异常

```python
# 第 362-368 行（改进后）
except Exception as e:
    logger.error(f"[{self.name}] 远程同步失败 ({rel_path}): {e}")
    try:
        self.transfer.ensure_connected()
    except Exception as reconnect_error:
        logger.warning(f"SSH 重连失败: {reconnect_error}")
    raise  # ← 关键：向上抛出异常，让调用者知道失败
```

**评价**：✅ SSH 同步的错误处理改进明显

### 3.2 传输模块改进 (`backend/core/transfer.py`)

**改动点**：
- 第 66-67 行：`except Exception as e: logger.debug(...)`
- 第 73-74 行：同上
- 第 83-84 行：同上
- 第 241-242 行：同上

```python
# 改进前
except:
    pass

# 改进后
except Exception as e:
    logger.debug(f"SFTP 连接关闭失败: {e}")
```

**评价**：✅ 符合规范，错误信息可追踪

### 3.3 API 层改进 (`backend/api/tasks.py`)

**新增函数**：
```python
# 第 130-160 行
def _build_task_response(db: Session, task: SyncTask) -> dict:
    """构建任务响应"""
    task_dict = TaskResponse.from_orm(task).model_dump()
    settings = get_task_settings(db, task.id)
    # ... 统一处理 settings 和 endpoints
    return task_dict
```

**使用处**：
- 第 169 行：`list_tasks` 调用
- 第 178 行：`get_task_detail` 调用

**评价**：✅ 消除重复代码，便于维护

---

## 四、遗留问题详解

### 4.1 🔴 高优先级：requirements.txt 缺少 cryptography

**文件**：`requirements.txt`

**当前内容**：
```
fastapi==0.115.0
uvicorn[standard]==0.32.0
watchdog==5.0.0
paramiko==3.5.0
pydantic==2.10.0
pydantic-settings==2.6.0
PyYAML==6.0.2
loguru==0.7.2
sqlalchemy==2.0.36
aiosqlite==0.20.0
websockets==14.1
python-multipart==0.0.20
```

**问题**：`crypto.py` 使用了 `cryptography` 库，但未在依赖中声明。

**修复**：
```bash
# 需要添加
cryptography>=41.0.0
```

### 4.2 🟡 中优先级：TaskRunner 同步状态记录

**文件**：`backend/core/task_manager.py` 第 123-135 行

```python
self.sync_engine.sync_file(event_type, rel_path, src_path, dest_path)

# 记录成功日志到 DB (虽然 Engine 内部可能失败，但这是一个 Compromise)
# 理想情况是 Engine 返回 result
with get_db() as db:
    create_log(db, {
        ...
        'status': 'success',  # 暂时假设成功 ← 问题仍在
    })
```

**现状**：
- SSH 引擎失败会抛异常，被 except 捕获后正确记录 failed
- 本地引擎失败也会抛异常（因为 `_handle_copy` 等不捕获异常）
- **实际上已经可以正确记录状态了**，但注释未更新

**建议**：删除"假设成功"的注释，避免误导。

### 4.3 🟡 中优先级：WebSocket 未实现

**技术方案要求**：
```
WS /ws/logs          # 实时日志推送
WS /ws/task-status   # 任务状态推送
```

**现状**：前端使用 5 秒轮询 (`setInterval(..., 5000)`)

### 4.4 🟢 低优先级：测试覆盖

**当前测试文件**（无变化）：
- `test_eol_normalizer.py`
- `test_file_utils.py`
- `test_sync_engine.py`

**缺失**：
- `crypto.py` 单元测试
- SSH 同步测试
- API 集成测试

---

## 五、安全性复查

### ✅ 已解决
| 问题 | 修复方式 |
|------|----------|
| 密码明文存储 | Fernet 加密 |
| 裸 except 隐藏错误 | 改为 `except Exception` 并记录日志 |

### ⚠️ 仍需注意
| 问题 | 风险级别 | 说明 |
|------|----------|------|
| SSH AutoAddPolicy | 中 | 可能遭受中间人攻击 |
| API 无认证 | 中 | 任何人可访问 Web 界面 |
| secret.key 权限 | 低 | 应确保文件权限为 600 |

---

## 六、功能完成度更新

| 需求阶段 | 完成度 | 变化 |
|---------|--------|------|
| Phase 1: 核心同步功能 | 100% ✅ | 无变化 |
| Phase 2: 远程传输 | 100% ✅ | 无变化 |
| Phase 3: Web 界面 | 95% ⚠️ | 无变化（仍缺 WebSocket） |
| Phase 4: 多任务支持 | 100% ✅ | 无变化 |
| Phase 5: 双向同步 | 100% ✅ | 无变化 |
| **安全加固** | **+20%** | **新增密码加密** |
| Phase 6: 高级特性 | 30% ❌ | 无变化 |
| Phase 7: 测试与优化 | 50% ⚠️ | 无变化 |

---

## 七、下一步建议

### 立即修复（高优先级）

1. **添加 cryptography 依赖**
   ```bash
   echo "cryptography>=41.0.0" >> requirements.txt
   ```

2. **确认 secret.key 在 .gitignore 中**
   ```bash
   # 检查
   grep "secret.key" .gitignore
   # 如果没有，添加
   echo "data/secret.key" >> .gitignore
   ```

### 短期改进（中优先级）

3. **实现 WebSocket 推送**
   - 使用 FastAPI 的 WebSocket 支持
   - 替换前端轮询逻辑

4. **添加 crypto.py 测试**
   ```python
   # tests/test_crypto.py
   def test_encrypt_decrypt():
       from backend.utils.crypto import encrypt_secret, decrypt_secret
       original = "my_password"
       encrypted = encrypt_secret(original)
       assert encrypted.startswith("enc:")
       decrypted = decrypt_secret(encrypted)
       assert decrypted == original
   ```

5. **清理代码注释**
   - 删除 `task_manager.py` 中"假设成功"的过时注释

### 长期规划（低优先级）

6. **添加 API 认证**（JWT 或 Session）
7. **改进 SSH 主机密钥验证**
8. **添加集成测试**

---

## 八、总结

### 本次修改评价：⭐⭐⭐⭐ 良好

Codex 针对上一版审计报告中的**高优先级问题**进行了有效修复：

| 问题 | 修复质量 |
|------|----------|
| 密码加密 | ⭐⭐⭐⭐⭐ 优秀（完整的加解密方案） |
| 裸 except | ⭐⭐⭐⭐ 良好（全部修复） |
| 重复代码 | ⭐⭐⭐⭐ 良好（抽取公共函数） |
| sync_file 返回值 | ⭐⭐⭐ 一般（SSH 改进，但注释未更新） |

**遗漏问题**：
- `requirements.txt` 未添加 `cryptography` 依赖

**整体进展**：项目安全性和代码质量均有明显提升。建议优先补充缺失的依赖，然后继续推进 WebSocket 和测试覆盖。

---

*报告生成时间：2026-01-27*
